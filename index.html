<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Link Hub</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234cbdb0'><path d='M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z'/></svg>">
<style>
/* --- Codepen Style Base & THEME VARIABLES --- */
:root {
  /* Light Theme (Default) */
  --c_black: #2e2e2e;
  --c_white: #f1f1f1;
  --c_gray: #e7e7e7;
  --c_blue: #425aef;
  --c_red: #ef4242;
  --c_black_tp: rgba(0,0,0,0.5);
  --c_white_tp: rgba(255,255,255,0.2);
  --f_sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";

  /* Theme-specific variables */
  --bg_app: rgba(255, 255, 255, 0.05);
  --bg_card: rgba(255,255,255,0.2);
  --bg_modal: rgba(255,255,255,0.25);
  --bg_input: rgba(255,255,255,0.3);
  --bg_input_focus: rgba(255,255,255,0.5);
  --bg_control_btn: rgba(255,255,255,0.2);
  --bg_control_btn_hover: rgba(255,255,255,0.4);
  --text_main: var(--c_black);
  --text_sub: var(--c_black_tp);
  --text_time: var(--c_white);
  --text_shadow_main: 0 1px 2px rgba(0,0,0,0.1);
  --text_shadow_time: 0 2px 4px rgba(0,0,0,0.5);
  --border_main: 1px solid rgba(255,255,255,0.3);
  --border_modal: 1px solid rgba(255,255,255,0.4);
  --shadow_card: 0 4px 12px rgba(0, 0, 0, 0.1);
  --shadow_modal: 0 8px 30px rgba(0,0,0,0.2);
  --backdrop_blur_app: 20px;
  --backdrop_blur_modal: 8px;

  /* --- Link Appearance Variables --- */
  --link_text_color: var(--text_main);
  --link_font_size: 16px;
}

body[data-theme="dark"] {
  --bg_app: rgba(26, 26, 26, 0.15);
  --bg_card: rgba(40, 40, 40, 0.3);
  --bg_modal: rgba(40, 40, 40, 0.5);
  --bg_input: rgba(50,50,50,0.4);
  --bg_input_focus: rgba(60,60,0.6);
  --bg_control_btn: rgba(50,50,50,0.4);
  --bg_control_btn_hover: rgba(70,70,70,0.6);
  --text_main: var(--c_white);
  --text_sub: rgba(255,255,255,0.5);
  --text_time: var(--c_white);
  --text_shadow_main: 0 1px 2px rgba(0,0,0,0.3);
  --text_shadow_time: 0 2px 6px rgba(0,0,0,0.7);
  --border_main: 1px solid rgba(255,255,255,0.2);
  --border_modal: 1px solid rgba(255,255,255,0.3);
  --shadow_card: 0 4px 16px rgba(0, 0, 0, 0.2);
  --shadow_modal: 0 8px 30px rgba(0,0,0,0.3);
  --backdrop_blur_app: 30px;
  --backdrop_blur_modal: 12px;
}

*, *::before, *::after {
  box-sizing: border-box;
}

html {
  overflow: hidden;
}

body {
  margin: 0;
  color: var(--text_main);
  font-family: var(--f_sans);
  font-size: 16px;
  background-image: url('background_.jpg');
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
  background-attachment: fixed;
  background-color: var(--c_gray);
  height: 100vh;
  width: 100vw;
  transition: color 0.3s ease, background-color 0.3s ease;
}

#app {
  width: 100%;
  height: 100vh;
  background-color: var(--bg_app);
  backdrop-filter: blur(var(--backdrop_blur_app));
  -webkit-backdrop-filter: blur(var(--backdrop_blur_app));
  transition: background-color 0.3s ease, backdrop-filter 0.3s ease;
}

.content-wrapper {
  width: 100%;
  max-width: 1600px;
  height: 100%;
  margin: 0 auto;
  padding: 32px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0;
  flex-shrink: 0;
}

.time-date-wrap {
  font-weight: 700;
  text-align: left;
}
.time-date-wrap .time {
  font-size: 28px;
  line-height: 1;
  color: var(--text_time);
  text-shadow: var(--text_shadow_time);
}
.time-date-wrap .date {
  font-size: 14px;
  color: var(--text_time);
  text-shadow: var(--text_shadow_time);
  opacity: 0.9;
}

.top-controls {
  display: flex;
  gap: 8px;
}

.control-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--bg_control_btn);
  border: var(--border_main);
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
  color: var(--text_main);
  position: relative;
  gap: 8px;
}
.control-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  background-color: var(--bg_control_btn_hover);
}
.control-btn .icon {
  width: 20px;
  height: 20px;
  margin: 0;
}
#color-picker-btn {
  padding: 8px 12px;
}

.color-swatch {
  display: block;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background-color: #ccc;
  border: 1px solid rgba(0,0,0,0.2);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
  transition: background-color 0.3s;
  flex-shrink: 0;
}
.color-code {
  font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
  font-size: 14px;
  font-weight: 600;
  color: var(--text_main);
  transition: color 0.3s;
}

.search-bar {
  margin-bottom: 0;
  flex-shrink: 0;
}
.search-input {
  width: 100%;
  padding: 12px 16px;
  border-radius: 8px;
  border: var(--border_main);
  font-size: 16px;
  font-family: var(--f_sans);
  background-color: var(--bg_input);
  box-shadow: 0 2px 4px rgba(0,0,0,0.05) inset;
  transition: all 0.2s ease;
  color: var(--text_main);
}
.search-input::placeholder { color: var(--text_sub); }
.search-input:focus {
  outline: none;
  border-color: var(--c_blue);
  box-shadow: 0 0 0 3px rgba(66, 90, 239, 0.2), 0 2px 4px rgba(0,0,0,0.05) inset;
  background-color: var(--bg_input_focus);
}

#link-container {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 24px;
  flex-grow: 1;
  overflow-y: auto;
  padding: 4px 12px 12px 4px;
}
#link-container::-webkit-scrollbar { width: 8px; }
#link-container::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.3); border-radius: 4px; }
#link-container::-webkit-scrollbar-track { background: transparent; }

.category-group {
  background-color: var(--bg_card);
  border: var(--border_main);
  border-radius: 12px;
  box-shadow: var(--shadow_card);
  transition: box-shadow .3s ease, background-color .3s ease;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  max-height: 400px;
}
.category-group.dragging {
    opacity: 0.7;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}
.category-group.drop-target {
    outline: 2px solid var(--c_blue);
    background-color: rgba(66, 90, 239, 0.3);
}

.category-header {
  display: flex;
  align-items: center;
  padding: 12px;
  border-bottom: var(--border_main);
  flex-shrink: 0;
}

.drag-handle {
  cursor: grab;
  color: var(--text_sub);
  padding: 4px;
  margin-right: 8px;
  display: flex;
  align-items: center;
}
.drag-handle:hover { color: var(--text_main); }
.drag-handle:active { cursor: grabbing; }

.category-header h2 {
  flex-grow: 1;
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  color: var(--text_main);
  text-shadow: var(--text_shadow_main);
}

.category-controls button {
  background: none;
  border: none;
  padding: 4px;
  cursor: pointer;
  color: var(--text_sub);
}
.category-controls button:hover { color: var(--text_main); }
.category-controls .delete-btn:hover { color: var(--c_red); }
.icon {
  width: 1em;
  height: 1em;
  display: inline-block;
  vertical-align: -0.15em;
  fill: currentColor;
}
.icon.no-margin { margin: 0; }

.links-list {
  list-style: none;
  padding: 8px;
  margin: 0;
  overflow-y: auto;
}
.links-list::-webkit-scrollbar { width: 6px; }
.links-list::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.3); border-radius: 3px; }
.links-list::-webkit-scrollbar-track { background: transparent; }

.link-item {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  border-radius: 8px;
  transition: background-color 0.2s;
  padding: 10px;
}

.link-wrapper {
  position: relative;
  flex-grow: 1;
  min-width: 0;
  padding-left: 28px;
}

.link-wrapper .icon {
  position: absolute;
  left: 0;
  top: 0.15em;
  width: 18px;
  height: 18px;
  color: var(--text_sub);
  transition: color 0.3s ease;
}

.link-wrapper a {
  color: var(--link_text_color);
  text-decoration: none;
}

.link-wrapper a span {
    font-weight: 500;
    font-size: var(--link_font_size);
    text-shadow: 0 1px 1px rgba(0,0,0,0.05);
    padding-bottom: 2px;
    background-image: linear-gradient(var(--link_text_color), var(--link_text_color));
    background-position: 0 100%;
    background-repeat: no-repeat;
    background-size: 0% 1px;
    transition: background-size 0.3s ease, font-size 0.3s ease, color 0.3s ease;
    -webkit-box-decoration-break: clone;
    box-decoration-break: clone;
}

.link-wrapper a:hover span {
    background-size: 100% 1px;
}

.link-item-controls {
  flex-shrink: 0;
  margin-left: 8px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  display: flex;
  gap: 4px;
}
.link-item:hover .link-item-controls {
  opacity: 1;
  visibility: visible;
}

.link-item-controls button {
  background: none;
  border: none;
  padding: 4px;
  cursor: pointer;
  color: var(--text_sub);
  font-size: 14px;
}
.link-item-controls button:hover { color: var(--text_main); }
.link-item-controls .delete-btn:hover { color: var(--c_red); }
.link-item-controls .swap-btn:hover,
.link-item-controls .edit-btn:hover { color: var(--c_blue); }


.link-item.selected-for-swap {
    background-color: rgba(66, 90, 239, 0.3);
    outline: 2px solid var(--c_blue);
}
.link-item.selected-for-swap .link-wrapper a, 
.link-item.selected-for-swap .link-wrapper .icon {
    color: var(--text_main);
}

.add-btn-wrap {
  position: fixed;
  right: 24px;
  bottom: 24px;
  z-index: 100;
}

.add-btn {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background-color: var(--c_blue);
  color: var(--c_white);
  border: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.3s ease;
}
.add-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
}
.add-btn .icon {
  width: 24px;
  height: 24px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(var(--backdrop_blur_modal));
  -webkit-backdrop-filter: blur(var(--backdrop_blur_modal));
}
.modal.active { display: flex; }

.modal-content {
  background-color: var(--bg_modal);
  backdrop-filter: blur(var(--backdrop_blur_app));
  -webkit-backdrop-filter: blur(var(--backdrop_blur_app));
  margin: auto;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  border-radius: 16px;
  border: var(--border_modal);
  box-shadow: var(--shadow_modal);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.modal-header h2 {
  margin: 0;
  font-size: 22px;
  color: var(--text_main);
  text-shadow: var(--text_shadow_main);
}
.modal-close {
  color: var(--text_sub);
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  background: none;
  border: none;
  line-height: 1;
}
.modal-close:hover,
.modal-close:focus {
  color: var(--text_main);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
}
.form-group label {
    font-weight: 600;
    font-size: 14px;
    color: var(--text_main);
    text-shadow: var(--text_shadow_main);
}
.form-group input, .form-group textarea {
    background-color: var(--bg_input);
    border: var(--border_modal);
    border-radius: 8px;
    padding: 12px;
    font-size: 16px;
    font-family: var(--f_sans);
    color: var(--text_main);
}
.form-group input:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--c_blue);
    box-shadow: 0 0 0 3px rgba(66, 90, 239, 0.2);
    background-color: var(--bg_input_focus);
}
.form-group textarea {
    min-height: 120px;
    resize: vertical;
}

.form-group-checkbox {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
    margin-bottom: 16px;
    padding: 10px;
    border-radius: 8px;
    background-color: rgba(0,0,0,0.05);
}
.form-group-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin: 0;
    accent-color: var(--c_blue);
}
.form-group-checkbox label {
    margin: 0;
    font-weight: 500;
    cursor: pointer;
}


.icon-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    background-color: rgba(0,0,0,0.05);
    padding: 8px;
    border-radius: 8px;
}
.icon-selector .icon-btn {
    background-color: var(--bg_input);
    border: 1px solid transparent;
    border-radius: 6px;
    padding: 6px;
    cursor: pointer;
    color: var(--text_sub);
    transition: all 0.2s ease;
}
.icon-selector .icon-btn:hover {
    color: var(--text_main);
    background-color: var(--bg_input_focus);
}
.icon-selector .icon-btn.selected {
    color: var(--c_blue);
    border-color: var(--c_blue);
    box-shadow: 0 0 0 2px rgba(66, 90, 239, 0.2);
}
.icon-selector .icon {
    width: 22px;
    height: 22px;
    display: block;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}
.modal-actions button {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}
.modal-actions .save-btn {
    background-color: var(--c_blue);
    color: var(--c_white);
}
.modal-actions .save-btn:hover {
    background-color: #2b43d1;
}
.modal-actions .cancel-btn {
    background-color: var(--bg_control_btn);
    border: var(--border_main);
    color: var(--text_main);
}
.modal-actions .cancel-btn:hover {
    background-color: var(--bg_control_btn_hover);
}

/* --- 設定モーダル用スタイル --- */
.form-group-range {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.form-group-range input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    background: var(--bg_input);
    border-radius: 4px;
    outline: none;
    opacity: 0.7;
    transition: opacity .2s;
    cursor: pointer;
}
.form-group-range input[type="range"]:hover {
    opacity: 1;
}
.form-group-range input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: var(--c_blue);
    border-radius: 50%;
    border: 2px solid var(--c_white);
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
}
.form-group-range input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: var(--c_blue);
    border-radius: 50%;
    border: 2px solid var(--c_white);
    box-shadow: 0 0 4px rgba(0,0,0,0.3);
}

.form-group-color-wrapper {
    padding: 12px;
    border: var(--border_modal);
    border-radius: 8px;
    margin-bottom: 16px;
}
.form-group-color {
    display: flex;
    align-items: center;
    gap: 12px;
}
.form-group-color-picker {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 12px;
}
.form-group-color input[type="color"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 38px;
    height: 38px;
    padding: 0;
    border: none;
    background-color: transparent;
    border-radius: 50%;
    cursor: pointer;
    overflow: hidden;
}
.form-group-color input[type="color"]::-webkit-color-swatch-wrapper {
    padding: 0;
}
.form-group-color input[type="color"]::-webkit-color-swatch {
    border: 2px solid var(--border_main);
    border-radius: 50%;
}
.form-group-color input[type="color"]::-moz-color-swatch {
    border: 2px solid var(--border_main);
    border-radius: 50%;
}
.form-group-color .color-hex-input {
    font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
    font-size: 14px;
    padding: 6px 8px;
    width: 100px;
    border-radius: 6px;
    text-transform: uppercase;
}
.color-picker-disabled {
    opacity: 0.5;
    pointer-events: none;
}
.modal-actions .reset-btn {
    background-color: var(--c_red);
    color: var(--c_white);
}
.modal-actions .reset-btn:hover {
    background-color: #d12b2b;
}

/* --- [NEW] Soft UI Theme (Neumorphism) --- */
body.soft-ui-theme {
  background-image: none;
  background-color: #e0e5ec;
  --text_main: #5d677a;
  --text_sub: #8a96ac;
  --text_time: #5d677a;
  --text_shadow_main: 1px 1px 1px #ffffff;
  --text_shadow_time: 1px 1px 1px #ffffff;
  --link_text_color: #5d677a;
  --c_blue: #6d5dfc;
}
body.soft-ui-theme #app {
  background-color: transparent;
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
}
body.soft-ui-theme .category-group,
body.soft-ui-theme .control-btn,
body.soft-ui-theme .add-btn {
  background: #e0e5ec;
  border: none;
  box-shadow: 5px 5px 10px #c5cdd8, -5px -5px 10px #ffffff;
  transition: box-shadow 0.2s ease, transform 0.2s ease;
}
body.soft-ui-theme .add-btn {
  color: var(--text_main);
}
body.soft-ui-theme .control-btn:hover,
body.soft-ui-theme .add-btn:hover {
  transform: translateY(-2px);
  box-shadow: 2px 2px 5px #c5cdd8, -2px -2px 5px #ffffff;
}
body.soft-ui-theme .control-btn:active,
body.soft-ui-theme .add-btn:active {
  transform: translateY(0);
  box-shadow: inset 4px 4px 8px #a3b1c6, inset -4px -4px 8px #ffffff;
}
body.soft-ui-theme .category-header {
  border-bottom: 1px solid #d1d9e6;
}
body.soft-ui-theme .search-input {
  background: #e0e5ec;
  border: none;
  border-radius: 16px;
  box-shadow: inset 5px 5px 12px #c8ced5, inset -5px -5px 12px #ffffff;
}
body.soft-ui-theme .search-input:focus {
  background: #e0e5ec;
  box-shadow: inset 3px 3px 7px #aeb6c1, inset -3px -3px 7px #ffffff;
}
body.soft-ui-theme .modal {
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  background-color: rgba(224, 229, 236, 0.7); /* --- 変更箇所1: 半透明に戻す --- */
}
body.soft-ui-theme .modal-content {
  background-color: #e0e5ec;
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  box-shadow: 12px 12px 24px #c8ced5; /* --- 変更箇所2: 白い影を削除 --- */
  border: 1px solid #d1d9e6;
}
body.soft-ui-theme .form-group input, 
body.soft-ui-theme .form-group textarea {
  background-color: #e0e5ec;
  border: 1px solid transparent;
  box-shadow: inset 4px 4px 8px #c5cdd8, inset -4px -4px 8px #fbffff;
}
body.soft-ui-theme .form-group input:focus, 
body.soft-ui-theme .form-group textarea:focus {
  box-shadow: inset 2px 2px 4px #c5cdd8, inset -2px -2px 4px #fbffff;
}
body.soft-ui-theme .modal-actions button {
  border: none;
  box-shadow: 5px 5px 10px #a3b1c6, -5px -5px 10px #ffffff;
}
body.soft-ui-theme .modal-actions .save-btn {
  background-color: var(--c_blue);
}
body.soft-ui-theme .modal-actions .cancel-btn {
  background: #e0e5ec;
}
body.soft-ui-theme .modal-actions button:hover {
  box-shadow: 2px 2px 5px #a3b1c6, -2px -2px 5px #ffffff;
}
body.soft-ui-theme .modal-actions button:active {
  box-shadow: inset 2px 2px 5px #a3b1c6, inset -2px -2px 5px #ffffff;
}
body.soft-ui-theme .link-wrapper a span {
    background-image: linear-gradient(var(--text_main), var(--text_main));
}
body.soft-ui-theme #link-container::-webkit-scrollbar-thumb {
  background-color: #a3b1c6;
}
body.soft-ui-theme .links-list::-webkit-scrollbar-thumb {
  background-color: #a3b1c6;
}


@media (max-width: 1200px) {
  #link-container { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 900px) {
  #link-container { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 600px) {
  .content-wrapper { padding: 16px; gap: 16px; }
  #app { backdrop-filter: blur(12px); }
  body.soft-ui-theme #app { backdrop-filter: none; }
  #link-container { grid-template-columns: 1fr; gap: 16px; }
}
</style>
</head>
<body>

<div id="app">
    <div class="content-wrapper">
        <header class="header">
            <div class="time-date-wrap">
                <time class="time">00:00</time>
                <time class="date">2025/01/01</time>
            </div>
            <div class="top-controls">
                <button class="control-btn" id="theme-toggle-btn" title="テーマを切り替え"></button>
                <!-- スタイル切り替えボタンと設定ボタンはJSでここに追加されます -->
                <button class="control-btn" id="export-btn" title="エクスポート"></button>
                <button class="control-btn" id="import-btn" title="インポート"></button>
                <button class="control-btn" id="color-picker-btn" title="スポイトで色を取得"></button>
            </div>
        </header>

        <div class="search-bar">
            <input type="text" id="search-input" class="search-input" placeholder="Search...">
        </div>

        <main id="link-container"></main>
    </div>

    <div class="add-btn-wrap">
        <button class="add-btn" id="add-category-btn" title="カテゴリを追加"></button>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">タイトル</h2>
            <button class="modal-close" id="modal-close">×</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const ICONS = {
        // System & UI Icons
        plus:   `<svg class="icon no-margin" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>`,
        export: `<svg class="icon no-margin" viewBox="0 0 24 24"><path d="M12 3l7 7h-4v6H9v-6H5l7-7zm-7 15h14v2H5v-2z"></path></svg>`,
        import: `<svg class="icon no-margin" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>`,
        grip:   `<svg class="icon no-margin" viewBox="0 0 24 24"><path d="M20 9H4v2h16V9zM4 15h16v-2H4v2z"></path></svg>`,
        trash:  `<svg class="icon no-margin" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>`,
        swap:   `<svg class="icon no-margin" viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"></path></svg>`,
        edit:   `<svg class="icon no-margin" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>`,
        sun: `<svg class="icon no-margin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
        moon: `<svg class="icon no-margin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
        settings: `<svg class="icon no-margin" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.44.17-.48.41L9.22 5.72C8.63 5.96 8.1 6.29 7.6 6.67L5.22 5.71C5 5.64 4.75 5.71 4.63 5.93l-1.92 3.32c-.12.2-.07.47.12.61l2.03 1.58C4.82 11.36 4.8 11.68 4.8 12s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.38 2.91c.04.24.24.41.48.41h3.84c.24 0 .44-.17-.48-.41l.38-2.91c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.07.47 0 .59-.22l1.92-3.32c.12-.2.07-.47-.12-.61L19.14 12.94zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.98 3.6-3.6 3.6z"/></svg>`,
        palette: `<svg class="icon no-margin" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>`,
        
        // Link Icons (Customizable)
        link:   `<svg class="icon" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg>`,
        external: `<svg class="icon" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5a2 2 0 0 1-2 2v14a2 2 0 0 1 2 2h14a2 2 0 0 1 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"></path></svg>`,
        home:   `<svg class="icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>`,
        code:   `<svg class="icon" viewBox="0 0 24 24"><path d="M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"></path></svg>`,
        github: `<svg class="icon" viewBox="0 0 24 24"><path d="M12 1.27a11 11 0 00-3.48 21.46c.55.1.73-.24.73-.53v-1.84c-3 .66-3.6-1.44-3.6-1.44-.5-1.27-1.22-1.6-1.22-1.6-1-.68.08-.67.08-.67 1.1.08 1.68 1.13 1.68 1.13.98 1.68 2.56 1.2 3.18.92.1-.7.38-1.2 1.1-1.48-2.4-.27-4.93-1.2-4.93-5.33 0-1.18.42-2.14 1.1-2.9-.1-.27-.48-1.36.1-2.84 0 0 .9-.3 3 1.1.87-.24 1.8-.36 2.73-.36s1.86.12 2.73.36c2.1-1.4 3-1.1 3-1.1.58 1.48.2 2.57.1 2.84.68.76 1.1 1.72 1.1 2.9 0 4.14-2.53 5.06-4.95 5.33.4.34.75 1.03.75 2.08v3.08c0 .3.18.63.73.53A11 11 0 0012 1.27z"></path></svg>`,
        youtube: `<svg class="icon" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M21.58,7.18 C21.36,6.32 20.69,5.65 19.83,5.43 C18.27,5 12,5 12,5 C12,5 5.73,5 4.17,5.43 C3.31,5.65 2.64,6.32 2.42,7.18 C2,8.74 2,12 2,12 C2,12 2,15.26 2.42,16.82 C2.64,17.68 3.31,18.35 4.17,18.57 C5.73,19 12,19 12,19 C12,19 18.27,19 19.83,18.57 C20.69,18.35 21.36,17.68 21.58,16.82 C22,15.26 22,12 22,12 C22,12 22,8.74 21.58,7.18 Z M10,9 L16,12 L10,15 Z"></path></svg>`,
        star:    `<svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg>`,
        email:   `<svg class="icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"></path></svg>`,
        doc:     `<svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"></path></svg>`,
        cart:    `<svg class="icon" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"></path></svg>`,
    };
    const LINK_ICON_KEYS = ['link', 'external', 'home', 'code', 'github', 'youtube', 'star', 'email', 'doc', 'cart'];
    
    const WEEKDAYS = ['日', '月', '火', '水', '木', '金', '土'];
    
    const APPEARANCE_STORAGE_KEY = 'linkHubAppearance';
    const STYLE_THEME_STORAGE_KEY = 'linkHubStyleTheme'; // 'glass' or 'soft'
    
    const DEFAULT_APPEARANCE = {
        fontSize: 16,
        light: { useCustom: false, color: '#2e2e2e' },
        dark: { useCustom: false, color: '#f1f1f1' },
    };

    function insertStaticIcons() {
        document.getElementById('add-category-btn').innerHTML = ICONS.plus;
        document.getElementById('export-btn').innerHTML = ICONS.export;
        document.getElementById('import-btn').innerHTML = ICONS.import;
        
        const settingsBtn = document.createElement('button');
        settingsBtn.className = 'control-btn';
        settingsBtn.id = 'settings-btn';
        settingsBtn.title = '表示設定';
        settingsBtn.innerHTML = ICONS.settings;
        
        const styleToggleBtn = document.createElement('button');
        styleToggleBtn.className = 'control-btn';
        styleToggleBtn.id = 'style-toggle-btn';
        styleToggleBtn.title = 'スタイルを切り替え';
        styleToggleBtn.innerHTML = ICONS.palette;
        
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        themeToggleBtn.after(styleToggleBtn);
        styleToggleBtn.after(settingsBtn);

        document.getElementById('color-picker-btn').innerHTML = `
            <span class="color-swatch"></span>
            <span class="color-code">#------</span>
        `;
    }

    const themeToggleButton = document.getElementById('theme-toggle-btn');
    
    function getCurrentTheme() {
        return document.body.dataset.theme || 'light';
    }

    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.dataset.theme = 'dark';
            themeToggleButton.innerHTML = ICONS.sun;
            themeToggleButton.title = "ライトテーマに切り替え";
        } else {
            delete document.body.dataset.theme;
            themeToggleButton.innerHTML = ICONS.moon;
            themeToggleButton.title = "ダークテーマに切り替え";
        }
        loadAppearanceSettings();
    }

    function toggleTheme() {
        const newTheme = getCurrentTheme() === 'dark' ? 'light' : 'dark';
        localStorage.setItem('linkHubTheme', newTheme);
        applyTheme(newTheme);
    }
    
    function applyStyleTheme(styleTheme) {
        const styleToggleButton = document.getElementById('style-toggle-btn');
        if (styleTheme === 'soft') {
            document.body.classList.add('soft-ui-theme');
            styleToggleButton.title = 'ガラススタイルに切り替え';
            // ソフトUIのときはダークテーマ切り替えを非表示にする
            themeToggleButton.style.display = 'none';
            // bodyのdata-themeを削除して、ダークテーマのスタイルが適用されないようにする
            if (document.body.dataset.theme) {
                delete document.body.dataset.theme;
            }
        } else { // 'glass'
            document.body.classList.remove('soft-ui-theme');
            styleToggleButton.title = 'ソフトスタイルに切り替え';
            themeToggleButton.style.display = 'flex';
            // ガラススタイルに戻ったら、保存されているライト/ダークテーマを再適用
            applyTheme(localStorage.getItem('linkHubTheme') || 'light');
        }
    }

    function toggleStyleTheme() {
        const currentIsSoft = document.body.classList.contains('soft-ui-theme');
        const newStyle = currentIsSoft ? 'glass' : 'soft';
        localStorage.setItem(STYLE_THEME_STORAGE_KEY, newStyle);
        applyStyleTheme(newStyle);
    }
    
    function showTime() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const dayOfWeek = WEEKDAYS[d.getDay()];
        const hour = String(d.getHours()).padStart(2, '0');
        const min = String(d.getMinutes()).padStart(2, '0');
        
        document.querySelector('.time').textContent = `${hour}:${min}`;
        document.querySelector('.date').textContent = `${year}/${month}/${day}（${dayOfWeek}）`;
    }
    setInterval(showTime, 1000);
    showTime();

    const linkContainer = document.getElementById('link-container');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalClose = document.getElementById('modal-close');

    let linkData = [];
    let swapState = null;
    let currentModalMode = null;
    let currentEditData = null;

    const defaultData = [
        { id: `cat-${Date.now()}-1`, title: 'Tools', links: [
            { id: `link-${Date.now()}-1`, name: 'Google', url: 'https://google.com', iconKey: 'external', openInNewWindow: false },
            { id: `link-${Date.now()}-2`, name: 'CodePen', url: 'https://codepen.io', iconKey: 'code', openInNewWindow: false },
            { id: `link-${Date.now()}-extra-3`, name: 'MDN Web Docs は、ウェブ開発者がウェブサイトやアプリケーションを構築するために使用する、オープンで共同作業によるリソースです。', url: 'https://developer.mozilla.org', iconKey: 'doc', openInNewWindow: false },
            { id: `link-${Date.now()}-extra-4`, name: 'GitHub', url: 'https://github.com', iconKey: 'github', openInNewWindow: false },
        ]},
        { id: `cat-${Date.now()}-2`, title: 'Social', links: [
            { id: `link-${Date.now()}-3`, name: 'Twitter / X', url: 'https://x.com', iconKey: 'home', openInNewWindow: false },
        ]},
        { id: `cat-${Date.now()}-5`, title: 'Entertainment', links: [
            { id: `link-${Date.now()}-6`, name: 'YouTube', url: 'https://youtube.com', iconKey: 'youtube', openInNewWindow: true },
        ]},
        { id: `cat-${Date.now()}-4`, title: 'Shopping', links: [
             { id: `link-${Date.now()}-7`, name: 'Amazon', url: 'https://amazon.com', iconKey: 'cart', openInNewWindow: false },
        ]},
    ];

    function loadData() {
        const savedData = localStorage.getItem('linkHubData');
        linkData = savedData ? JSON.parse(savedData) : defaultData;
        render();
    }

    function saveData() {
        localStorage.setItem('linkHubData', JSON.stringify(linkData));
    }

    // --- Appearance Settings ---
    function getAppearanceSettings() {
        const savedSettings = localStorage.getItem(APPEARANCE_STORAGE_KEY);
        return savedSettings 
            ? { ...DEFAULT_APPEARANCE, ...JSON.parse(savedSettings) }
            : { ...DEFAULT_APPEARANCE };
    }

    function saveAppearanceSettings(settings) {
        localStorage.setItem(APPEARANCE_STORAGE_KEY, JSON.stringify(settings));
        loadAppearanceSettings();
    }

    function applyAppearanceSettings(settings) {
        const root = document.documentElement;
        const theme = getCurrentTheme();
        
        root.style.setProperty('--link_font_size', `${settings.fontSize}px`);

        if (document.body.classList.contains('soft-ui-theme')) {
            root.style.removeProperty('--link_text_color');
            return;
        }

        const colorConfig = settings[theme];
        if (colorConfig && colorConfig.useCustom) {
            root.style.setProperty('--link_text_color', colorConfig.color);
        } else {
            root.style.removeProperty('--link_text_color');
        }
    }
    
    function loadAppearanceSettings() {
        const settings = getAppearanceSettings();
        applyAppearanceSettings(settings);
    }
    
    function render() {
        if (swapState && swapState.element) {
            swapState.element.classList.remove('selected-for-swap');
        }
        swapState = null;
        linkContainer.innerHTML = '';
        linkData.forEach(category => linkContainer.appendChild(createCategoryElement(category)));
    }

    function createCategoryElement(category) {
        const categoryGroup = document.createElement('div');
        categoryGroup.className = 'category-group';
        categoryGroup.dataset.categoryId = category.id;
        const header = document.createElement('div');
        header.className = 'category-header';
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.draggable = true;
        dragHandle.innerHTML = ICONS.grip;
        const title = document.createElement('h2');
        title.title = 'ダブルクリックで編集';
        title.textContent = category.title;
        const controls = document.createElement('div');
        controls.className = 'category-controls';
        controls.innerHTML = `
            <button class="add-link-btn" title="リンクを追加">${ICONS.plus}</button>
            <button class="delete-cat-btn delete-btn" title="カテゴリを削除">${ICONS.trash}</button>
        `;
        header.append(dragHandle, title, controls);
        const linksList = document.createElement('ul');
        linksList.className = 'links-list';
        if (category.links) {
            category.links.forEach(link => linksList.appendChild(createLinkElement(link)));
        }
        categoryGroup.append(header, linksList);
        return categoryGroup;
    }

    function createLinkElement(link) {
        const linkItem = document.createElement('li');
        linkItem.className = 'link-item';
        linkItem.dataset.linkId = link.id;
        const linkWrapper = document.createElement('div');
        linkWrapper.className = 'link-wrapper';
        const anchor = document.createElement('a');
        anchor.href = link.url;
        anchor.target = '_blank';
        anchor.rel = 'noopener noreferrer';
        anchor.addEventListener('click', (event) => {
            event.preventDefault();
            if (link.openInNewWindow) {
                const windowFeatures = 'width=1000,height=700,menubar=yes,toolbar=yes,location=yes,resizable=yes,scrollbars=yes';
                window.open(link.url, '_blank', windowFeatures);
            } else {
                window.open(link.url, '_blank', 'noopener,noreferrer');
            }
        });
        const iconSvg = ICONS[link.iconKey] || ICONS.link;
        const span = document.createElement('span');
        span.textContent = link.name;
        anchor.appendChild(span);
        linkWrapper.innerHTML = iconSvg;
        linkWrapper.appendChild(anchor);
        const controls = document.createElement('div');
        controls.className = 'link-item-controls';
        controls.innerHTML = `
            <button class="edit-btn" title="編集">${ICONS.edit}</button>
            <button class="swap-btn" title="入れ替え">${ICONS.swap}</button>
            <button class="delete-link-btn delete-btn" title="リンクを削除">${ICONS.trash}</button>
        `;
        linkItem.append(linkWrapper, controls);
        return linkItem;
    }


    function openModal(mode, data = null) {
        currentModalMode = mode;
        currentEditData = data;
        modalBody.innerHTML = '';
        let formContent;

        switch(mode) {
            case 'addCategory':
                modalTitle.textContent = 'カテゴリを追加';
                formContent = createFormFragment(
                    [{ label: 'カテゴリ名', id: 'category-name', placeholder: '新しいカテゴリ' }],
                    { save: '追加', cancel: 'キャンセル' }
                );
                break;
            case 'addLink':
                modalTitle.textContent = 'リンクを追加';
                formContent = createFormFragment(
                    [
                        { label: 'リンク名', id: 'link-name', placeholder: 'リンク名' },
                        { label: 'URL', id: 'link-url', type: 'url', placeholder: 'https://example.com' },
                        { type: 'icon_selector', label: 'アイコン', id: 'link-icon', value: 'link' },
                        { type: 'checkbox', label: '新しいウィンドウで開く', id: 'open-new-window', checked: false }
                    ],
                    { save: '追加', cancel: 'キャンセル' }
                );
                break;
            case 'editLink':
                modalTitle.textContent = 'リンクを編集';
                formContent = createFormFragment(
                    [
                        { label: 'リンク名', id: 'link-name', value: data.link.name },
                        { label: 'URL', id: 'link-url', type: 'url', value: data.link.url },
                        { type: 'icon_selector', label: 'アイコン', id: 'link-icon', value: data.link.iconKey || 'link' },
                        { type: 'checkbox', label: '新しいウィンドウで開く', id: 'open-new-window', checked: data.link.openInNewWindow || false }
                    ],
                    { save: '保存', cancel: 'キャンセル' }
                );
                break;
            case 'exportData':
                modalTitle.textContent = 'データのエクスポート';
                formContent = createFormFragment(
                    [{ label: '以下のデータをコピーして、.jsonファイルとして保存してください。', id: 'export-data', type: 'textarea', value: JSON.stringify(linkData, null, 2), readonly: true }],
                    { cancel: '閉じる' }
                );
                break;
            case 'importData':
                modalTitle.textContent = 'データのインポート';
                formContent = createFormFragment(
                    [{ label: 'ここにJSONデータを貼り付けてください。', id: 'import-data', type: 'textarea', placeholder: '[\n  {\n    "id": "...",\n    ...\n  }\n]' }],
                    { save: 'インポート実行', cancel: 'キャンセル' }
                );
                break;
            case 'appearanceSettings':
                modalTitle.textContent = '表示設定';
                const currentSettings = getAppearanceSettings();
                formContent = createFormFragment(
                    [
                        { type: 'range', label: `フォントサイズ (${currentSettings.fontSize}px)`, id: 'font-size', min: 12, max: 24, step: 1, value: currentSettings.fontSize, unit: 'px' },
                        { type: 'color_theme', theme: 'light', label: 'ライトテーマ時の色', settings: currentSettings.light },
                        { type: 'color_theme', theme: 'dark', label: 'ダークテーマ時の色', settings: currentSettings.dark },
                    ],
                    { reset: 'デフォルトに戻す', save: '保存して閉じる' }
                );
                break;
        }

        if (formContent) {
            modalBody.appendChild(formContent);
        }
        modal.classList.add('active');
        const firstInput = modalBody.querySelector('input, textarea');
        if (firstInput) firstInput.focus();
    }

    function createFormFragment(fields, actions) {
        const fragment = document.createDocumentFragment();
        fields.forEach(field => {
            let group, label, input;

            switch(field.type) {
                case 'checkbox':
                    group = document.createElement('div');
                    group.className = 'form-group-checkbox';
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = field.id;
                    input.checked = field.checked;
                    label = document.createElement('label');
                    label.htmlFor = field.id;
                    label.textContent = field.label;
                    group.append(input, label);
                    fragment.appendChild(group);
                    break;

                case 'range':
                    group = document.createElement('div');
                    group.className = 'form-group form-group-range';
                    label = document.createElement('label');
                    label.htmlFor = field.id;
                    label.textContent = field.label;
                    input = document.createElement('input');
                    input.type = 'range';
                    input.id = field.id;
                    input.min = field.min;
                    input.max = field.max;
                    input.step = field.step;
                    input.value = field.value;
                    input.addEventListener('input', () => {
                        label.textContent = `フォントサイズ (${input.value}${field.unit})`;
                    });
                    group.append(label, input);
                    fragment.appendChild(group);
                    break;
                
                case 'color_theme':
                    const wrapper = document.createElement('div');
                    wrapper.className = 'form-group-color-wrapper';

                    label = document.createElement('label');
                    label.textContent = field.label;
                    label.style.marginBottom = '8px';
                    wrapper.appendChild(label);

                    const colorGroup = document.createElement('div');
                    colorGroup.className = 'form-group-color';
                    
                    const pickerDiv = document.createElement('div');
                    pickerDiv.className = 'form-group-color-picker';
                    pickerDiv.id = `picker-div-${field.theme}`;

                    const colorInput = document.createElement('input');
                    colorInput.type = 'color';
                    colorInput.id = `color-input-${field.theme}`;
                    colorInput.value = field.settings.color;

                    const hexInput = document.createElement('input');
                    hexInput.type = 'text';
                    hexInput.className = 'form-group input color-hex-input';
                    hexInput.id = `hex-input-${field.theme}`;
                    hexInput.value = field.settings.color.toUpperCase();
                    
                    colorInput.addEventListener('input', () => hexInput.value = colorInput.value.toUpperCase());
                    hexInput.addEventListener('change', () => {
                        let val = hexInput.value;
                        if (!val.startsWith('#')) val = '#' + val;
                        if (/^#[0-9A-F]{6}$/i.test(val)) {
                           colorInput.value = val;
                        } else {
                           hexInput.value = colorInput.value.toUpperCase();
                        }
                    });

                    pickerDiv.append(colorInput, hexInput);
                    
                    const defaultCheckboxGroup = document.createElement('div');
                    defaultCheckboxGroup.className = 'form-group-checkbox';
                    defaultCheckboxGroup.style.margin = '0 0 0 12px';
                    const defaultCheckbox = document.createElement('input');
                    defaultCheckbox.type = 'checkbox';
                    defaultCheckbox.id = `default-cb-${field.theme}`;
                    defaultCheckbox.checked = !field.settings.useCustom;
                    const defaultLabel = document.createElement('label');
                    defaultLabel.htmlFor = `default-cb-${field.theme}`;
                    defaultLabel.textContent = 'Default';

                    defaultCheckbox.addEventListener('change', () => {
                        pickerDiv.classList.toggle('color-picker-disabled', defaultCheckbox.checked);
                    });
                    // Initial state
                    if (!field.settings.useCustom) {
                        pickerDiv.classList.add('color-picker-disabled');
                    }

                    defaultCheckboxGroup.append(defaultCheckbox, defaultLabel);
                    colorGroup.append(pickerDiv, defaultCheckboxGroup);
                    wrapper.appendChild(colorGroup);
                    fragment.appendChild(wrapper);
                    break;
                
                case 'icon_selector':
                    group = document.createElement('div');
                    group.className = 'form-group';
                    label = document.createElement('label');
                    label.htmlFor = field.id;
                    label.textContent = field.label;
                    group.appendChild(label);
                    const selectorContainer = document.createElement('div');
                    selectorContainer.className = 'icon-selector';
                    selectorContainer.id = field.id;
                    LINK_ICON_KEYS.forEach(key => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'icon-btn';
                        btn.dataset.iconKey = key;
                        btn.innerHTML = ICONS[key];
                        if (key === field.value) btn.classList.add('selected');
                        btn.onclick = () => {
                            selectorContainer.querySelector('.selected')?.classList.remove('selected');
                            btn.classList.add('selected');
                        };
                        selectorContainer.appendChild(btn);
                    });
                    group.appendChild(selectorContainer);
                    fragment.appendChild(group);
                    break;
                
                default: // text, textarea, url, etc.
                    group = document.createElement('div');
                    group.className = 'form-group';
                    label = document.createElement('label');
                    label.htmlFor = field.id;
                    label.textContent = field.label;
                    group.appendChild(label);

                    input = document.createElement(field.type === 'textarea' ? 'textarea' : 'input');
                    input.id = field.id;
                    if (field.type !== 'textarea') input.type = field.type || 'text';
                    if (field.placeholder) input.placeholder = field.placeholder;
                    if (field.value) input.value = field.value;
                    if (field.readonly) input.readOnly = true;
                    input.required = true;
                    group.appendChild(input);
                    fragment.appendChild(group);
                    break;
            }
        });

        if (actions) {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'modal-actions';
            if (actions.reset) {
                const resetBtn = document.createElement('button');
                resetBtn.className = 'reset-btn';
                resetBtn.textContent = actions.reset;
                resetBtn.onclick = () => {
                    if (confirm('表示設定をデフォルトに戻しますか？')) {
                        saveAppearanceSettings(DEFAULT_APPEARANCE);
                        closeModal();
                    }
                };
                actionsDiv.appendChild(resetBtn);
            }
            if (actions.cancel) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'cancel-btn';
                cancelBtn.textContent = actions.cancel;
                cancelBtn.onclick = closeModal;
                actionsDiv.appendChild(cancelBtn);
            }
            if (actions.save) {
                const saveBtn = document.createElement('button');
                saveBtn.className = 'save-btn';
                saveBtn.textContent = actions.save;
                saveBtn.onclick = saveModalData;
                actionsDiv.appendChild(saveBtn);
            }
            fragment.appendChild(actionsDiv);
        }
        return fragment;
    }

    function closeModal() {
        if (currentModalMode === 'appearanceSettings') {
            loadAppearanceSettings();
        }
        modal.classList.remove('active');
        currentModalMode = null;
        currentEditData = null;
    }

    window.saveModalData = function() {
        switch(currentModalMode) {
            case 'appearanceSettings':
                const newSettings = {
                    fontSize: document.getElementById('font-size').value,
                    light: {
                        useCustom: !document.getElementById('default-cb-light').checked,
                        color: document.getElementById('color-input-light').value
                    },
                    dark: {
                        useCustom: !document.getElementById('default-cb-dark').checked,
                        color: document.getElementById('color-input-dark').value
                    }
                };
                saveAppearanceSettings(newSettings);
                closeModal();
                break;
            case 'addCategory':
                const categoryName = document.getElementById('category-name').value.trim();
                if (categoryName) {
                    linkData.unshift({ id: `cat-${Date.now()}`, title: categoryName, links: [] });
                    saveData(); render(); closeModal();
                }
                break;
            case 'addLink':
                const linkName = document.getElementById('link-name').value.trim();
                const linkUrl = document.getElementById('link-url').value.trim();
                const selectedIconEl = document.querySelector('#link-icon .selected');
                const linkIconKey = selectedIconEl ? selectedIconEl.dataset.iconKey : 'link';
                const openInNewWindow = document.getElementById('open-new-window').checked;
                if (linkName && linkUrl) {
                    const category = linkData.find(c => c.id === currentEditData.categoryId);
                    if (category) {
                        category.links.push({
                            id: `link-${Date.now()}`,
                            name: linkName,
                            url: linkUrl,
                            iconKey: linkIconKey,
                            openInNewWindow: openInNewWindow
                        });
                        saveData(); render(); closeModal();
                    }
                }
                break;
            case 'editLink':
                const editedName = document.getElementById('link-name').value.trim();
                const editedUrl = document.getElementById('link-url').value.trim();
                const editedIconEl = document.querySelector('#link-icon .selected');
                const editedIconKey = editedIconEl ? editedIconEl.dataset.iconKey : 'link';
                const editedOpenInNewWindow = document.getElementById('open-new-window').checked;
                if (editedName && editedUrl) {
                    const category = linkData.find(c => c.id === currentEditData.categoryId);
                    if (category) {
                        const link = category.links.find(l => l.id === currentEditData.linkId);
                        if (link) {
                            link.name = editedName;
                            link.url = editedUrl;
                            link.iconKey = editedIconKey;
                            link.openInNewWindow = editedOpenInNewWindow;
                            saveData(); render(); closeModal();
                        }
                    }
                }
                break;
            case 'importData':
                const importText = document.getElementById('import-data').value;
                if (!importText) { alert('テキストエリアにデータを貼り付けてください。'); return; }
                try {
                    const imported = JSON.parse(importText);
                    if (Array.isArray(imported)) {
                        if (confirm('現在のデータをインポートしたデータで上書きしますか？この操作は元に戻せません。')) {
                            linkData = imported;
                            saveData(); render(); closeModal();
                        }
                    } else { alert('無効なJSON形式です。配列形式のデータが必要です。'); }
                } catch (error) { alert('データの読み込み中にエラーが発生しました。JSON形式が正しいか確認してください。'); }
                break;
        }
    };

    function editCategoryTitle(h2Element, categoryId) {
        const currentTitle = h2Element.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentTitle;
        input.className = 'category-title-edit-input';
        input.style.cssText = "font-size: 18px; font-weight: 700; width: 100%; border:none; background: var(--bg_input_focus); padding: 2px 4px; border-radius: 4px; outline: 1px solid var(--c_blue); color: var(--text_main);";
        h2Element.replaceWith(input);
        input.focus();
        input.select();
        const save = () => {
            const newTitle = input.value.trim();
            if (newTitle && newTitle !== currentTitle) {
                const category = linkData.find(c => c.id === categoryId);
                if (category) {
                    category.title = newTitle;
                    saveData();
                }
            }
            render();
        };
        input.addEventListener('blur', save);
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') input.blur();
            if (e.key === 'Escape') render();
        });
    }

    function deleteCategory(categoryId) {
        if (confirm('このカテゴリとすべてのリンクを削除しますか？')) {
            linkData = linkData.filter(c => c.id !== categoryId);
            saveData(); render();
        }
    }

    function deleteLink(categoryId, linkId) {
        const category = linkData.find(c => c.id === categoryId);
        if (category) {
            category.links = category.links.filter(l => l.id !== linkId);
            saveData(); render();
        }
    }

    function handleSwapLinkClick(clickedButton) {
        const linkItem = clickedButton.closest('.link-item');
        const categoryId = clickedButton.closest('.category-group').dataset.categoryId;
        const linkId = linkItem.dataset.linkId;
        if (!swapState) {
            swapState = { categoryId, linkId, element: linkItem };
            linkItem.classList.add('selected-for-swap');
        } else {
            if (swapState.linkId === linkId) {
                linkItem.classList.remove('selected-for-swap');
                swapState = null;
                return;
            }
            const firstCategory = linkData.find(c => c.id === swapState.categoryId);
            const secondCategory = linkData.find(c => c.id === categoryId);
            if (firstCategory && secondCategory) {
                const firstLinkIndex = firstCategory.links.findIndex(l => l.id === swapState.linkId);
                const secondLinkIndex = secondCategory.links.findIndex(l => l.id === linkId);
                if (firstLinkIndex > -1 && secondLinkIndex > -1) {
                    [firstCategory.links[firstLinkIndex], secondCategory.links[secondLinkIndex]] =
                    [secondCategory.links[secondLinkIndex], firstCategory.links[firstLinkIndex]];
                    saveData(); render();
                }
            }
        }
    }

    async function handleColorPickerClick() {
        if (!('EyeDropper' in window)) {
            alert('お使いのブラウザはスポイト機能に対応していません。');
            return;
        }
        const colorPickerBtn = document.getElementById('color-picker-btn');
        try {
            const eyeDropper = new EyeDropper();
            const result = await eyeDropper.open();
            const colorHex = result.sRGBHex;
            const swatch = colorPickerBtn.querySelector('.color-swatch');
            const codeDisplay = colorPickerBtn.querySelector('.color-code');
            if (swatch) swatch.style.backgroundColor = colorHex;
            if (codeDisplay) codeDisplay.textContent = colorHex.toUpperCase();
            await navigator.clipboard.writeText(colorHex);
            const originalTitle = 'スポイトで色を取得';
            colorPickerBtn.title = `コピーしました: ${colorHex.toUpperCase()}`;
            setTimeout(() => { colorPickerBtn.title = originalTitle; }, 2000);
        } catch (e) {
            console.log('EyeDropper was cancelled.');
        }
    }

    function setupEventListeners() {
        themeToggleButton.onclick = toggleTheme;
        document.getElementById('style-toggle-btn').onclick = toggleStyleTheme;
        document.getElementById('add-category-btn').onclick = () => openModal('addCategory');
        document.getElementById('settings-btn').onclick = () => openModal('appearanceSettings');
        document.getElementById('export-btn').onclick = () => openModal('exportData');
        document.getElementById('import-btn').onclick = () => openModal('importData');
        document.getElementById('search-input').addEventListener('input', filterContent);
        document.getElementById('color-picker-btn').addEventListener('click', handleColorPickerClick);
        modalClose.onclick = closeModal;
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        linkContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            if (button.closest('.link-item-controls')) e.preventDefault();
            const categoryGroup = button.closest('.category-group');
            const linkItem = button.closest('.link-item');
            if (button.classList.contains('add-link-btn')) openModal('addLink', { categoryId: categoryGroup.dataset.categoryId });
            else if (button.classList.contains('delete-cat-btn')) deleteCategory(categoryGroup.dataset.categoryId);
            else if (button.classList.contains('delete-link-btn')) deleteLink(categoryGroup.dataset.categoryId, linkItem.dataset.linkId);
            else if (button.classList.contains('swap-btn')) handleSwapLinkClick(button);
            else if (button.classList.contains('edit-btn')) {
                const categoryId = categoryGroup.dataset.categoryId;
                const linkId = linkItem.dataset.linkId;
                const category = linkData.find(c => c.id === categoryId);
                const link = category.links.find(l => l.id === linkId);
                openModal('editLink', { categoryId, linkId, link });
            }
        });

        linkContainer.addEventListener('dblclick', e => {
            const h2 = e.target.closest('h2');
            if (h2) editCategoryTitle(h2, h2.closest('.category-group').dataset.categoryId);
        });

        setupCategoryDragAndDrop();
    }

    function setupCategoryDragAndDrop() {
        let draggedElement = null;
        linkContainer.addEventListener('dragstart', (e) => {
            if (e.target.closest('.drag-handle')) {
                draggedElement = e.target.closest('.category-group');
                setTimeout(() => { draggedElement.classList.add('dragging'); }, 0);
            }
        });
        linkContainer.addEventListener('dragend', () => {
            if (draggedElement) draggedElement.classList.remove('dragging');
            draggedElement = null;
            document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
        });
        linkContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            const targetCategory = e.target.closest('.category-group:not(.dragging)');
            document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
            if (targetCategory && draggedElement) targetCategory.classList.add('drop-target');
        });
        linkContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetEl = e.target.closest('.category-group.drop-target');
            document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
            if (!targetEl || !draggedElement || targetEl === draggedElement) return;
            const newOrderIds = Array.from(linkContainer.querySelectorAll('.category-group')).map(el => el.dataset.categoryId);
            const draggedId = draggedElement.dataset.categoryId;
            const targetId = targetEl.dataset.categoryId;
            const draggedIndex = newOrderIds.indexOf(draggedId);
            const targetIndex = newOrderIds.indexOf(targetId);
            newOrderIds.splice(draggedIndex, 1);
            newOrderIds.splice(targetIndex, 0, draggedId);
            linkData.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
            saveData();
            render();
        });
    }

    function filterContent() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('.category-group').forEach(cat => {
            const categoryName = cat.querySelector('h2')?.textContent.toLowerCase() || '';
            let hasVisibleLinks = false;
            cat.querySelectorAll('.link-item').forEach(item => {
                const linkName = item.querySelector('span').textContent.toLowerCase();
                const isVisible = linkName.includes(searchTerm);
                item.style.display = isVisible ? 'flex' : 'none';
                if (isVisible) hasVisibleLinks = true;
            });
            cat.style.display = (categoryName.includes(searchTerm) || hasVisibleLinks) ? 'flex' : 'none';
        });
    }

    // --- Initial Setup ---
    insertStaticIcons();
    
    // 最初にStyleテーマ(Glass or Soft)を適用
    const savedStyleTheme = localStorage.getItem(STYLE_THEME_STORAGE_KEY) || 'glass';
    applyStyleTheme(savedStyleTheme);

    // 次にライト/ダークテーマを適用 (applyStyleTheme内で必要に応じて呼ばれる)
    const savedTheme = localStorage.getItem('linkHubTheme') || 'light';
    applyTheme(savedTheme);

    loadData();
    setupEventListeners();
});
</script>

</body>
</html>
